# FRONT_UPSELL_UI.md â€” Upsell & Cross-sell (UI) â€” Essence Ãrabe

> Objetivo: Aumentar ticket mÃ©dio e conversÃ£o com **upsell/cross-sell** em pontos-chave do funil.
> Escopo: Somente **interface + regras locais (mock)**. IntegraÃ§Ã£o real com backend depois.

---

## 0) Onde vamos aplicar upsell (pontos do funil)

1) **PDP** (pÃ¡gina do produto): â€œCompre juntoâ€, â€œTamanho maiorâ€, â€œMais vendidoâ€
2) **Carrinho**: order bump + bundles + barra de frete grÃ¡tis
3) **Checkout** (antes do pagamento): 1 oferta simples (sem distrair)
4) **PÃ³s-compra** (Thank you / Order Success): â€œOferta relÃ¢mpago 10 minâ€
5) **WhatsApp** (prÃ©-formatado): mensagens de â€œrecuperaÃ§Ã£oâ€ e â€œoferta complementarâ€

---

## 1) Tipos de oferta (MVP)

### 1.1 Order Bump (1 clique no carrinho/checkout)
- Ex: â€œLeve um decant 10ml com 15% OFFâ€
- Regras:
  - sÃ³ 1 bump por pedido
  - aparece quando carrinho â‰¥ R$ X (mock)
  - adiciona item automaticamente no cart draft

### 1.2 Bundle (kit)
- Ex: â€œKit Doces Ãrabe (Khamrah + Eclair) â€” economize R$ 29â€
- Regras:
  - bundle define preÃ§o fixo (mock)
  - exibe â€œeconomiaâ€ comparando com soma avulsa

### 1.3 Upgrade de variante (tamanho maior)
- Ex: 100ml â†’ 150ml â€œpor +R$ 39â€
- Regras:
  - aparece na PDP e no carrinho quando item elegÃ­vel

### 1.4 Frete progressivo (barra)
- Ex: â€œFaltam R$ 48 para Frete GrÃ¡tisâ€
- Regras:
  - limiar configurÃ¡vel `freeShippingThreshold`

### 1.5 PÃ³s-compra (one-time offer / OTO)
- Ex: â€œAdicionar +1 perfume com 10% OFF (vale por 10 min)â€
- Regras:
  - sÃ³ 1 OTO por pedido
  - expira por timer
  - botÃ£o â€œAdicionar ao pedidoâ€ (no MVP, vira novo pedido draft ou â€œpedido complementarâ€ local)

---

## 2) Rotas e PÃ¡ginas impactadas

- `/produto/:slug` (PDP)
- `/carrinho`
- `/checkout` (step review)
- `/pedido/sucesso/:orderCode` (thank you)
- (opcional) `/oferta/:campaignSlug` (landing de campanha)

---

## 3) Modelos (Front-only)

Criar `src/types/upsell.ts`

### 3.1 UpsellOffer
- `id: string`
- `type: 'ORDER_BUMP' | 'BUNDLE' | 'UPGRADE' | 'POST_PURCHASE'`
- `title: string`
- `subtitle?: string`
- `productIds: string[]` (ou SKUs)
- `discountType?: 'PERCENT' | 'FIXED'`
- `discountValue?: number`
- `fixedBundlePrice?: number`
- `eligibility: { minCartTotal?: number; requiresProductId?: string; excludeIfInCart?: string[] }`
- `priority: number`
- `ui: { badge?: string; image?: string; ctaText: string }`

PersistÃªncia:
- `EA_UPSELL_CONFIG_V1` (mock config)
- `EA_UPSELL_EVENTS_V1` (eventos)

### 3.2 UpsellEvent (telemetria local)
- `ts: string`
- `sessionId: string`
- `offerId: string`
- `action: 'IMPRESSION' | 'CLICK' | 'ACCEPT' | 'DECLINE'`
- `context: 'PDP' | 'CART' | 'CHECKOUT' | 'THANK_YOU'`
- `orderCode?: string`
- `cartValue?: number`

---

## 4) Componentes (UI)

### 4.1 UpsellShelf (PDP / Carrinho)
Arquivo: `src/components/upsell/UpsellShelf.tsx`

Props:
- `context`
- `cart`
- `currentProductId?`

Render:
- cards horizontais (scroll)
- cada card: imagem, nome, inspiraÃ§Ã£o (texto curto), preÃ§o, CTA â€œAdicionarâ€

Regra MVP:
- pega top N ofertas ordenadas por `priority` e `eligibility`

---

### 4.2 OrderBumpCard (Carrinho/Checkout)
Arquivo: `src/components/upsell/OrderBumpCard.tsx`

Layout:
- checkbox grande â€œAdicionarâ€
- preÃ§o riscado + preÃ§o com desconto
- microcopy: â€œEntrega junto no mesmo pacoteâ€

AÃ§Ã£o:
- ao marcar, adiciona item no cart
- registra `UpsellEvent: ACCEPT`

---

### 4.3 BundleCard (Carrinho)
Arquivo: `src/components/upsell/BundleCard.tsx`

Exibir:
- itens do kit
- economia (badge)
- CTA â€œAdicionar kitâ€

---

### 4.4 FreeShippingProgress (Carrinho)
Arquivo: `src/components/upsell/FreeShippingProgress.tsx`

- progress bar simples
- texto dinÃ¢mico conforme total

---

### 4.5 PostPurchaseOfferModal (Thank You)
Arquivo: `src/components/upsell/PostPurchaseOfferModal.tsx`

- modal com timer (10:00)
- CTA primÃ¡ria â€œAdicionar com descontoâ€
- CTA secundÃ¡ria â€œNÃ£o, obrigadoâ€
- aviso: â€œOferta Ãºnica desta compraâ€

MVP:
- se â€œaceitarâ€: cria â€œpedido complementarâ€ local ou adiciona ao `EA_CUSTOMER_ORDERS_V1` como `UPSELL_CHILD_ORDER`
- (futuro) API: `POST /orders/:id/post-purchase-offer/accept`

---

## 5) Regras canÃ´nicas (MVP pragmÃ¡tico)

### 5.1 Limitar fricÃ§Ã£o
- Checkout: no mÃ¡ximo **1 oferta** (Order Bump).
- Carrinho: pode ter shelf + bundle + barra frete (sem excesso).

### 5.2 Evitar ofertas irrelevantes
- Se carrinho jÃ¡ tem o produto, nÃ£o oferecer.
- Preferir complementaridade por â€œfamÃ­lia olfativaâ€ (mock tags):
  - doce / amadeirado / fresco / especiado / Ã¢mbar

### 5.3 Guardrails de margem (UI-ready)
- Oferta sÃ³ aparece se `estimatedMargin >= minMargin`
- MVP: `minMargin` fixo no config
- (futuro) margem vem da API

---

## 6) Copy/UX (mensagens prontas)

Badges:
- â€œMais vendidoâ€
- â€œCombina com Khamrahâ€
- â€œOferta relÃ¢mpagoâ€
- â€œEconomize R$ Xâ€

CTAs:
- â€œAdicionar ao carrinhoâ€
- â€œAdicionar com descontoâ€
- â€œQuero esse comboâ€
- â€œGarantir agoraâ€

Microcopy:
- â€œEnviamos em atÃ© 24hâ€
- â€œEmbalagem premiumâ€
- â€œPerfume inspirado em fragrÃ¢ncias famosasâ€

---

## 7) WhatsApp (recuperaÃ§Ã£o + upsell)

Criar helper: `src/lib/whatsapp.ts`

Templates:
1) Carrinho abandonado:
- â€œVi que vocÃª quase finalizou seu pedido. Quer que eu gere um cupom?â€

2) PÃ³s-compra:
- â€œSeu pedido foi confirmado âœ… Quer aproveitar uma oferta complementar com desconto hoje?â€

MVP:
- botÃµes â€œFalar no WhatsAppâ€ que abrem link com mensagem pronta.

---

## 8) MÃ©tricas (front event tracking)

Eventos mÃ­nimos:
- `upsell_impressions_total{context,offerId}`
- `upsell_accept_rate{context,offerId}`
- `bundle_attach_rate`
- `order_bump_attach_rate`
- `aov` (ticket mÃ©dio â€” no MVP, calculado local)

No MVP:
- sÃ³ salva em `localStorage` para anÃ¡lise manual
- (futuro) enviar para backend/analytics

---

## 9) Checklist (DoD)

- [x] UpsellShelf em PDP e Carrinho
  - [x] Componente criado com scroll horizontal
  - [x] Integrado na ProductPage (PDP)
  - [x] Integrado no Cart
  - [x] Filtra ofertas elegÃ­veis por contexto
- [x] OrderBumpCard no Carrinho e no Checkout
  - [x] Componente com checkbox e preÃ§o com desconto
  - [x] Integrado no Cart
  - [x] Integrado no Checkout (step de revisÃ£o)
  - [x] Adiciona item automaticamente ao marcar
- [x] BundleCard no Carrinho
  - [x] Componente com produtos do kit
  - [x] Exibe economia calculada
  - [x] Integrado no Cart
- [x] FreeShippingProgress no Carrinho
  - [x] Barra de progresso dinÃ¢mica
  - [x] Mensagem quando frete grÃ¡tis alcanÃ§ado
  - [x] Integrado no Cart
- [x] PostPurchaseOfferModal na tela de sucesso
  - [x] Modal com timer countdown (10 minutos)
  - [x] Aparece automaticamente apÃ³s 2 segundos
  - [x] Integrado no OrderSuccess
- [x] Regras bÃ¡sicas de elegibilidade funcionando
  - [x] Verifica valor mÃ­nimo do carrinho
  - [x] Exclui produtos jÃ¡ no carrinho
  - [x] Filtra por contexto (PDP, CART, CHECKOUT, THANK_YOU)
  - [x] Ordena por prioridade
- [x] Registro de UpsellEvents em localStorage
  - [x] Tracking de impressÃµes, cliques, aceites e recusas
  - [x] FunÃ§Ã£o para calcular mÃ©tricas
  - [x] PersistÃªncia em `EA_UPSELL_EVENTS_V1`
- [x] Links de WhatsApp com templates
  - [x] Helper para gerar links do WhatsApp
  - [x] Templates para carrinho abandonado e pÃ³s-compra
  - [x] FunÃ§Ã£o para abrir WhatsApp com mensagem prÃ©-formatada

---

## 10) Status de ImplementaÃ§Ã£o

**Data de conclusÃ£o:** Janeiro 2025

### âœ… Implementado

- **Tipos:** `src/types/upsell.ts` com UpsellOffer, UpsellEvent, UpsellConfig
- **Dados Mock:** `src/data/upsellOffers.ts` com ofertas de order bump, bundles e post-purchase
- **Tracking:** `src/lib/upsellTracking.ts` para eventos de upsell
- **WhatsApp:** `src/lib/whatsapp.ts` com templates de mensagens
- **Componentes:**
  - `FreeShippingProgress` - Barra de progresso para frete grÃ¡tis
  - `OrderBumpCard` - Card de oferta com checkbox
  - `BundleCard` - Card de kit com economia
  - `UpsellShelf` - Shelf horizontal de produtos relacionados
  - `PostPurchaseOfferModal` - Modal com timer para oferta pÃ³s-compra
- **IntegraÃ§Ãµes:**
  - ProductPage: UpsellShelf na PDP
  - Cart: FreeShippingProgress, OrderBumpCard, BundleCard, UpsellShelf
  - Checkout: OrderBumpCard no step de revisÃ£o
  - OrderSuccess: PostPurchaseOfferModal automÃ¡tico

### ğŸ“ ObservaÃ§Ãµes

- Todas as ofertas sÃ£o mockadas e elegÃ­veis baseadas em regras locais
- Tracking de eventos salvo em localStorage para anÃ¡lise futura
- Timer do PostPurchaseOfferModal expira apÃ³s 10 minutos
- FreeShippingProgress calcula progresso baseado em threshold configurÃ¡vel
- Regras de elegibilidade evitam ofertas duplicadas ou irrelevantes

---

## 11) PrÃ³ximo .md

`FRONT_CHECKOUT_UI.md` â€” Checkout "coisa fina": steps, autofill, endereÃ§o, pagamento (UI), confirmaÃ§Ã£o e sucesso. *(JÃ¡ implementado anteriormente)*
